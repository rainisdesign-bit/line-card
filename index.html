<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>åç‰‡åˆ†äº« | RainThink Design</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f8f9fa; }
        .card { background: white; padding: 35px; border-radius: 24px; text-align: center; width: 85%; max-width: 350px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); }
        #shareBtn { background: #06C755; color: white; border: none; padding: 16px 0; width: 100%; border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; transition: 0.3s; }
        #shareBtn:disabled { background: #eee; color: #bbb; cursor: not-allowed; }
        .status-msg { font-size: 14px; color: #666; margin-bottom: 8px; line-height: 1.5; }
        .debug-info { font-size: 10px; color: #ddd; margin-top: 20px; text-align: left; word-break: break-all; border-top: 1px solid #f0f0f0; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h3 id="targetName">é›¨æ€åç‰‡ç³»çµ±</h3>
        <p id="info" class="status-msg">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</p>
        <button id="shareBtn" onclick="doShare()" disabled>è«‹ç¨å€™...</button>
        <div id="debug" class="debug-info">ç³»çµ±åˆå§‹åŒ–...</div>
    </div>

    <script>
        const LIFF_ID = '2009104422-Un7RU7tQ'; 
        const GAS_API = 'https://script.google.com/macros/s/AKfycbwtAVozv0JnuTdPRI3y-dPZN_MOWnafxc74nPP4NbVqS8ukNTp_5fiJPxLl6kMC4S8i/exec';
        let flexData = null;

        // ğŸŸ¢ æ ¸å¿ƒé‚è¼¯ï¼šåœ¨ç¬¬ä¸€æ¯«ç§’å°±æ¶æ•‘ ID
        function getID() {
            const url = window.location.href;
            const urlObj = new URL(url);
            
            // 1. å„ªå…ˆå¾éŒ¨é» (#) æŠ“å–
            let id = window.location.hash.substring(1);
            if (id && !id.includes('access_token')) return decodeURIComponent(id);

            // 2. å˜—è©¦å¾æ¨™æº–åƒæ•¸ (?id=) æŠ“å–
            let idParam = urlObj.searchParams.get('id');
            if (idParam && !idParam.includes('access_token')) return idParam;

            // 3. å˜—è©¦å¾ LINE è·³è½‰å¾Œçš„ state æŠ“å–
            const state = urlObj.searchParams.get('liff.state');
            if (state) {
                const stateParams = new URLSearchParams(state.startsWith('?') ? state : '?' + state);
                let stateId = stateParams.get('id');
                if (stateId) return stateId;
            }

            // 4. å¾æœ¬åœ°ç¡¬ç¢Ÿæ¢å¾© (é€™æ˜¯æœ€ç©©çš„ä¸€é“é˜²ç·š)
            return localStorage.getItem('last_vcard_id');
        }

        async function init() {
            const info = document.getElementById('info');
            const btn = document.getElementById('shareBtn');
            const debug = document.getElementById('debug');

            const currentId = getID();
            if (currentId) {
                localStorage.setItem('last_vcard_id', currentId); // æ°¸ä¹…è¨˜ä½
                debug.innerText = "å·²é–å®š ID: " + currentId;
            } else {
                info.innerText = "è«‹ç”±åç‰‡é€£çµé€²å…¥";
                debug.innerText = "æœªåµæ¸¬åˆ° ID åƒæ•¸";
                return;
            }

            try {
                // å‘ GAS è«‹æ±‚è³‡æ–™
                const response = await fetch(`${GAS_API}?id=${encodeURIComponent(currentId)}`);
                const result = await response.json();
                
                if (result.success) {
                    flexData = result.data;
                    document.getElementById('targetName').innerText = result.name;
                    info.innerText = "è³‡æ–™åŒæ­¥å®Œæˆ";
                    
                    await liff.init({ liffId: LIFF_ID });
                    btn.innerText = liff.isLoggedIn() ? "ç«‹å³åˆ†äº«åç‰‡" : "é»æ“Šç™»å…¥ä¸¦åˆ†äº«";
                    btn.disabled = false;
                } else {
                    info.innerText = "æ‰¾ä¸åˆ°è³‡æ–™ï¼š" + currentId;
                }
            } catch (err) {
                debug.innerText = "éŒ¯èª¤: " + err.message;
            }
        }

        async function doShare() {
            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });
            } else {
                try {
                    const res = await liff.shareTargetPicker([flexData]);
                    if (res) liff.closeWindow();
                } catch (err) {
                    alert("è«‹ç¢ºèª LINE Developers å¾Œå°å·²å‹¾é¸ shareTargetPicker æ¬Šé™");
                }
            }
        }
        init();
    </script>
</body>
</html>
